# Linux文本处理之sed

sed 是 Linux 中的一个常用的行编辑器，主要用于文本替换等操作。

## sed 工作原理概述

sed 的基本工作方式如下：

1. 将文件以行为单位读取到内存（模式空间）中。
2. 使用 sed 的每个脚本对该行进行操作。
3. 处理完成后输出该行。


## sed 替换命令s

上面，我们已经提到了，sed 最常用的使用场景就是文本替换了。

一个最简单的sed命令如下:

```shell
sed 's/old/new/' filename
```

上式表示对`filename`文件的逐行进行处理，只要找到old匹配的字符串，就全部替换为new。

如果我们想要进行多个替换操作时，上述命令需要改写如下:

```shell
sed -e 's/old/new/' -e 's/old1/new1/' filename1 filename2
```

即在每个替换命令前都加上一个 `-e` 即可。

或者可以修改如下：

```shell
sed 's/old/new/;s/old1/new1/' filename1 filename2
```

即多个替换命令可以拼接在一起，中间使用`;`进行间隔。

在上述 sed 命令中，我们按行进行了处理，并将处理的结果打印到了终端上，实际上对原始文件并没有进行任何改动。

如果我们想要直接对原始文件进行修改应该怎么办呢？非常简单，只需要加上 `-i` 参数即可，例如：

```shell
sed -i -e 's/old/new/' -e 's/old1/new1/' filename1 filename2
```

此外，我们在使用扩展正则表达式进行匹配替换时，还需要增加`-r`参数，例如:

```shell
sed -r 's/扩展正则表达式/new/' filename
```

有时，我们希望将匹配的内容在新的行中出现多次，那么应该怎么实现呢？

```shell
sed -r 's/(a.*b)/\1:\1/' filename
```

下面，我们来解读一下上述命令的含义：

1. 首先，匹配的内容是一个aXXXXb的一个字符串。
2. 接下来，将这个aXXXXb的一个字符串用()包围表示一个整体。
3. 新字符串中，用`\1`表示()包围的这个整体。
4. 也就是说，上述替换会把aXXXXb字符串替换为aXXXXb:aXXXXb字符串。


### 全量替换

之前的 sed 命令的使用中，我们可以发现，如果在一行中，匹配到了多次 old 字符串时，默认仅仅会将第一个匹配到的字段串进行替换。

如果我们希望将全部出现的old字符串都替换成new字符串时应该怎么做呢？

```shell
s/old/new/g
```

Ps: 可以看到，我们在替换操作的最后，增加了一个`g`，这个`g`就表示替换所有出现的old字符串。

有时，我们既不希望全部替换，也不希望替换第一个匹配项，而是希望替换第二个或者第n个匹配项时，那么可以修改如下:

```shell
s/old/new/2
```

即将最后的g改为期望替换的匹配项序号。

此外，如果带替换的字符串中包含/时，分割字符串也可以修改为其他符号，例如:

```shell
s@old@new@g
```

其功能效果与上述是一样的。

### 寻址范围

默认情况下，sed命令在文本处理时，会依次处理中文本中的每一行。

有时候，我们会希望让 sed 命令仅仅处理文本中的满足特定条件的行，例如正则匹配的行，指定区间的行等等。

场景1: 只用sed命令处理正则表达式匹配的行

```shell
/正则表达式/s/old/new/g
```

场景2: 只用sed命令处理指定行数的行

```shell
行号s/old/new/g
# 在第五行到第十行进行替换
5,10s/old/new/g
# 在第五行以后进行替换
5,$s/old/new/g
```

场景3: 寻址且多条sed命令组合

```shell
/正则表达式/{s/old/new/g;s/old1/new1/g}
```

需要注意的是，刚寻址和多条sed命令组合时，多条sed命令除了之间需要用分号分隔之外，还需要用{}进行包围。

### sed 脚本文件

当 sed 命令希望反复使用时，可以将其接入一个文件中，并直接使用该脚本文件即可。

```shell
sed -f sedscript filename
```

## sed 其他指令

### 删除

基本格式如下: `[寻址]d` 或 `/正则表达式/d`

示例如下：

```shell
1,2d
```

Ps: 一旦匹配后，匹配的内容之后的内容会全部被删除。d命令之后其他的命令后不会生效。

### 追加a、插入i、更改c

```shell
sed '/ab/i hello' bfile
```

上式表示在 `bfile` 文件中匹配 `ab`，一旦匹配，则该匹配行之前插入一个`hello`。

```shell
sed '/ab/a hello' bfile
```

上式表示在 `bfile` 文件中匹配 `ab`，一旦匹配，则该匹配行之后插入一个`hello`。

```shell
sed '/ab/c hello' bfile
```

上式表示在 `bfile` 文件中匹配 `ab`，一旦匹配，则该匹配行修改为`hello`。


### 退出命令

退出命令表示当满足匹配条件后，直接退出，不再处理后续的行。

例如:

```shell
sed 10q filenmae
```

## sed 多行模式空间

默认情况下，sed命令是以单行模式进行处理的。但是，sed其实也支持了多行模式的处理。

sed 在多行处理时有如下关键命令:

 - N: 将下一行加入到模式空间。
 - D: 删除模式空间中的第一个字符到第一个换行符。
 - P: 打印模式空间的的第一个字符到第一个换行符。


示例代码如下:

```shell
sed 'N;s/he.*lo/!!!/g' a.txt
```

上式表示先将行合并，然后再进行替换。

一个结合 N、D、P的复杂sed脚本如下:

```shell
sed 'N;s/\n//;s/hello bash/hello sed\n/;P;D' a.txt
```


## sed 保持空间

sed 保持空间也是sed多行处理的一种操作方式，即将内容暂存在保持空间，便于多行处理。

涉及到的指令包括:

 - h 和 H 将模式空间内容存放到保持空间
 - g 和 G 将保持空间内容取出到模式空间
 - x 交换模式空间和保存空间的内容

Ps: 小写表示覆盖模式，大写表示追加模式。
